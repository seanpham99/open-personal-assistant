# Open Personal Assistant MVP Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a functional Daemon-CLI bridge using TypeScript and a self-hosted Supabase backend (Docker).

**Architecture:** 
- **Backend:** Node.js (Fastify) Daemon connecting to Supabase.
- **CLI:** TypeScript CLI (Commander.js) communicating with the Daemon.
- **Infrastructure:** Local Supabase (Docker Compose) providing Postgres, Auth, Vector, and Vault.

**Tech Stack:** TypeScript, Node.js, Fastify, Commander.js, Supabase (Self-hosted), Zod, Biome.

---

### Task 1: Project Initialization & Supabase Setup

**Files:**
- Create: `package.json`
- Create: `tsconfig.json`
- Create: `supabase/config.toml` (or standard supabase init structure)
- Create: `docker-compose.yml` (for Supabase self-hosting)

**Step 1: Initialize Node.js project**

Run: `npm init -y`

**Step 2: Install core dependencies**

Run: `npm install fastify @supabase/supabase-js commander zod dotenv`
Run: `npm install -D typescript @types/node @types/ws tsx biome`

**Step 3: Configure TypeScript**

Create `tsconfig.json` with `strict: true`, `target: ES2022`, `moduleResolution: bundler`.

**Step 4: Initialize Supabase (Local)**

*Assumption: User has Docker installed.*
Run: `npx supabase init`
*Action: Create a basic schema migration for `tasks` and `vault` tables.*

**Step 5: Commit**

```bash
git add .
git commit -m "chore: init typescript project and supabase config"
```

---

### Task 2: Supabase Schema & Vault

**Files:**
- Create: `supabase/migrations/20240101000000_init.sql`
- Test: `tests/db.test.ts`

**Step 1: Define Schema (SQL)**

Create migration file with:
- Enable `pgvector` and `supa_vault` extensions.
- Create `secrets` table (managed by Vault).
- Create `agents` and `tasks` tables.

**Step 2: Start Supabase**

Run: `npx supabase start` (This spins up the local Docker stack).

**Step 3: Generate Types**

Run: `npx supabase gen types typescript --local > src/types/supabase.ts`

**Step 4: Commit**

```bash
git add supabase/
git commit -m "feat: add initial supabase migration and vault setup"
```

---

### Task 3: Daemon (Fastify) Implementation

**Files:**
- Create: `src/daemon/index.ts`
- Create: `src/daemon/server.ts`
- Test: `tests/daemon.test.ts`

**Step 1: Basic Server Setup**

Implement Fastify server with a health check route `GET /health`.

**Step 2: Supabase Connection**

Initialize Supabase client in the daemon using `process.env.SUPABASE_URL` and `SERVICE_ROLE_KEY`.

**Step 3: Write Test**

Use `tap` or `vitest` to verify `/health` returns 200 and Supabase connects.

**Step 4: Commit**

```bash
git add src/daemon
git commit -m "feat: implement basic daemon with supabase connection"
```

---

### Task 4: CLI (Commander) Implementation

**Files:**
- Create: `src/cli/index.ts`

**Step 1: Basic CLI Structure**

Use `commander` to define a `status` command.

**Step 2: Connect to Daemon**

Implement `fetch('http://localhost:3000/health')` inside the `status` command.

**Step 3: Build & Link**

Add `"bin": {"assistant": "./dist/cli/index.js"}` to `package.json`.

**Step 4: Commit**

```bash
git add src/cli
git commit -m "feat: add basic CLI to query daemon status"
```